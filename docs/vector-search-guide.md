# 🔍 벡터 유사도 검색 가이드

## 벡터 검색이란?

**키워드 매칭 vs 벡터 유사도 검색**

### 키워드 매칭 (단순 텍스트 검색)
```
검색어: "프로그래밍"
결과: "프로그래밍"이라는 단어가 포함된 텍스트만 찾음

"저는 파이썬 프로그래밍을 좋아합니다" ✅
"저는 코딩을 즐깁니다" ❌  (프로그래밍이라는 단어가 없음)
"개발자로 일합니다" ❌
```

### 벡터 유사도 검색 (의미 기반 검색)
```
검색어: "프로그래밍"
결과: 의미적으로 관련된 모든 텍스트를 찾음

"저는 파이썬 프로그래밍을 좋아합니다" ✅ (점수: 0.95)
"저는 코딩을 즐깁니다" ✅ (점수: 0.85)
"개발자로 일합니다" ✅ (점수: 0.78)
"등산을 좋아합니다" ❌ (점수: 0.15)
```

## mem0의 벡터 검색

### 작동 방식

1. **저장 시**:
   - 텍스트 → 임베딩 모델 (nomic-embed-text) → 벡터
   - 벡터를 ChromaDB에 저장

2. **검색 시**:
   - 검색어 → 임베딩 벡터 → ChromaDB에서 유사 벡터 검색
   - 코사인 유사도로 점수 계산
   - 높은 점수 순으로 결과 반환

### 이중 저장 시스템

```
사용자 입력 → mem0
              ├─ ChromaDB (벡터 저장)
              └─ local_memories.json (백업)

검색 시:
1차: ChromaDB 벡터 검색 (우선)
2차: 로컬 텍스트 매칭 (폴백)
```

## 벡터 검색 테스트

### 1. 상태 확인
```bash
python test_vector_search.py
# 선택 2: 빠른 상태 확인
```

**확인 사항**:
- ✅ mem0 활성화 여부
- ✅ ChromaDB 폴더 존재
- ✅ 벡터 파일 크기

### 2. 전체 테스트
```bash
python test_vector_search.py
# 선택 1: 전체 테스트
```

**테스트 항목**:
- 메모리 저장 → 벡터 변환
- 유사도 검색 정확도
- 동의어 검색 (프로그래밍 = 코딩)
- 관련어 검색 (커피 → 음료)

## 벡터 검색 vs 텍스트 매칭 비교

### 예시 1: 동의어 검색

**메모리**: "저는 파이썬 개발자입니다"

#### 벡터 검색 (mem0)
```python
검색: "프로그래머"
결과: ✅ "저는 파이썬 개발자입니다" (점수: 0.87)
```

#### 텍스트 매칭 (로컬)
```python
검색: "프로그래머"
결과: ❌ 없음 ("프로그래머"라는 단어가 없음)
```

### 예시 2: 관련 개념 검색

**메모리들**:
- "커피를 좋아합니다"
- "아메리카노를 매일 마십니다"
- "카페에 자주 갑니다"

#### 벡터 검색
```python
검색: "음료"
결과:
  ✅ "커피를 좋아합니다" (0.82)
  ✅ "아메리카노를 매일 마십니다" (0.79)
  ✅ "카페에 자주 갑니다" (0.71)
```

#### 텍스트 매칭
```python
검색: "음료"
결과: ❌ 없음 (모두 "음료"라는 단어를 포함하지 않음)
```

### 예시 3: 문맥 이해

**메모리**: "비 오는 날을 좋아합니다"

#### 벡터 검색
```python
검색: "날씨"
결과: ✅ "비 오는 날을 좋아합니다" (0.75)
```

#### 텍스트 매칭
```python
검색: "날씨"
결과: ✅ "비 오는 날을 좋아합니다" (0.90)
       (단어 매칭으로 찾음)
```

## 벡터 검색이 작동하지 않는 경우

### 증상
- 정확한 키워드만 검색됨
- 유사어/동의어 검색 안 됨
- 검색 결과가 너무 제한적

### 원인 및 해결

#### 1. mem0 인스턴스가 None
```python
# 확인
python -c "from core.memory_manager_simple import SimpleMemoryManager; from config.settings import load_config; m = SimpleMemoryManager(load_config()); print('mem0:', m.memory is not None)"

# 해결
python setup_models.py
```

#### 2. ChromaDB 초기화 실패
```bash
# 확인
ls data/chroma_db  # 파일 있어야 함

# 해결
rm -rf data/chroma_db
mkdir data/chroma_db
# 메모리 다시 저장
```

#### 3. 임베딩 모델 없음
```bash
# 확인
ollama list

# 해결
ollama pull nomic-embed-text
```

## 성능 비교

### 검색 정확도

| 검색어 | 메모리 | 벡터 검색 | 텍스트 매칭 |
|--------|--------|-----------|-------------|
| "프로그래밍" | "코딩 좋아함" | ✅ (0.85) | ❌ |
| "음료" | "커피 마심" | ✅ (0.82) | ❌ |
| "개발" | "프로그래머" | ✅ (0.88) | ❌ |
| "커피" | "커피 좋아함" | ✅ (0.95) | ✅ (0.95) |

### 검색 속도

- **벡터 검색**: ~100-300ms (임베딩 + DB 검색)
- **텍스트 매칭**: ~10-50ms (메모리 스캔)

💡 **권장**: 정확도가 중요하면 벡터 검색, 속도가 중요하면 텍스트 매칭

## 최적화 팁

### 1. 임계값 설정
```python
# 관련성이 높은 것만
results = await search_memories(
    query="프로그래밍",
    user_id=user_id,
    threshold=0.7  # 0.7 이상만 반환
)
```

### 2. 결과 수 제한
```python
# 상위 3개만
results = await search_memories(
    query="커피",
    user_id=user_id,
    limit=3
)
```

### 3. 메모리 분류 활용
```python
# 카테고리별 필터링
results = [r for r in results
           if r['metadata'].get('category') == 'preferences']
```

## 실전 활용

### 개인화된 추천
```python
# 사용자 취향 검색
preferences = await search_memories(
    query="좋아하는 것",
    user_id=user_id,
    limit=10
)

# 벡터 검색으로 관련 선호도 모두 찾음
# "커피 좋아함", "달콤한 것 좋아함", "영화 보기 좋아함" 등
```

### 문맥 기반 대화
```python
# 현재 대화 주제와 관련된 기억 찾기
relevant = await search_memories(
    query=current_message,
    user_id=user_id,
    limit=5
)

# 유사도 기반으로 가장 관련있는 메모리 활용
```

## 결론

✅ **벡터 검색의 장점**:
- 의미 기반 검색
- 동의어/유사어 자동 매칭
- 문맥 이해

⚠️ **제약사항**:
- 임베딩 모델 필요
- 벡터 DB 저장 공간
- 약간 느린 속도

💡 **mem0의 이중 시스템**:
- 벡터 검색 우선
- 실패 시 텍스트 매칭 폴백
- 안정성과 성능 모두 확보

---

`python test_vector_search.py`로 시스템 상태를 확인하세요! 🚀